name: Build HomeProxy Firmware for XG-040G-MD (ä¼˜åŒ–ç‰ˆ)

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'ğŸ”§ SSHè¿æ¥è°ƒè¯•æ¨¡å¼'
        required: false
        default: false
        type: boolean
      log_switch:
        description: 'ğŸ“ è¯¦ç»†ç¼–è¯‘æ—¥å¿—'
        required: false
        default: false
        type: boolean
      clean_build:
        description: 'ğŸ§¹ æ¸…ç†ç¼–è¯‘ï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼‰'
        required: false
        default: false
        type: boolean
      minimal_build:
        description: 'âš¡ æœ€å°åŒ–ç¼–è¯‘ï¼ˆè·³è¿‡å¤§å‹åŒ…ï¼‰'
        required: false
        default: false
        type: boolean

env:
  CONFIG_FILE: 'config/040new.config'
  REPO_URL: https://github.com/bingoguo93/immortalwrt
  REPO_BRANCH: openwrt-25.12
  FEEDS_CONF: feeds.conf.default
  DIY_P4_SH: diy-part4-homeproxy.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  
jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6å°æ—¶è¶…æ—¶
    
    steps:
    - name: Checkout
      uses: actions/checkout@master

    - name: Show system info
      run: |
        echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
        echo "CPU: $(nproc) æ ¸å¿ƒ"
        echo "å†…å­˜:"
        free -h
        echo "ç£ç›˜:"
        df -h
        echo "ç³»ç»Ÿç‰ˆæœ¬:"
        cat /etc/os-release

    - name: Free disk space aggressively
      run: |
        echo "=== æ¸…ç†å‰ç£ç›˜ç©ºé—´ ==="
        df -h
        
        # æ¸…ç†ä¸å¿…è¦çš„è½¯ä»¶åŒ…
        sudo apt-get clean
        sudo apt-get autoremove -y
        
        # æ¸…ç† Docker é•œåƒ
        docker system prune -a -f || true
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        sudo rm -rf /tmp/*
        sudo rm -rf /var/tmp/*
        
        # æ¸…ç†å¤§æ–‡ä»¶
        sudo rm -rf /opt/hostedtoolcache
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/share/dotnet
        
        echo "=== æ¸…ç†åç£ç›˜ç©ºé—´ ==="
        df -h

    - name: Create swap space
      run: |
        echo "=== åˆ›å»ºäº¤æ¢ç©ºé—´ ==="
    
        # å…³é—­æ‰€æœ‰ç°æœ‰äº¤æ¢
        sudo swapoff -a 2>/dev/null || true
    
        # åˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº¤æ¢æ–‡ä»¶
        sudo rm -f /swapfile 2>/dev/null || true
    
        # ç¡®ä¿ç£ç›˜æœ‰è¶³å¤Ÿç©ºé—´
        df -h /
    
        # ä½¿ç”¨ dd å‘½ä»¤åˆ›å»ºäº¤æ¢æ–‡ä»¶ï¼ˆæ›´å¯é ï¼‰
        echo "ä½¿ç”¨ dd åˆ›å»º 3GB äº¤æ¢æ–‡ä»¶..."
        sudo dd if=/dev/zero of=/swapfile bs=1M count=3072 status=progress
    
        if [ $? -eq 0 ]; then
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
      
          echo "âœ… äº¤æ¢ç©ºé—´åˆ›å»ºæˆåŠŸ"
          echo "äº¤æ¢ç©ºé—´çŠ¶æ€ï¼š"
          sudo swapon --show
          free -h
      
          # è®¾ç½®äº¤æ¢ä½¿ç”¨å€¾å‘
          echo 60 | sudo tee /proc/sys/vm/swappiness
        else
          echo "âŒ äº¤æ¢ç©ºé—´åˆ›å»ºå¤±è´¥ï¼Œç»§ç»­ç¼–è¯‘ä½†ä¸ä½¿ç”¨äº¤æ¢"
        fi

    - name: Setup ccache with optimization
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: openwrt-homeproxy-${{ env.REPO_BRANCH }}-${{ github.run_id }}
        restore-keys: |
          openwrt-homeproxy-${{ env.REPO_BRANCH }}-
          openwrt-homeproxy-
        max-size: 5G
        # å¦‚æœé€‰æ‹©æ¸…ç†ç¼–è¯‘ï¼Œåˆ™ä¸ç”¨ç¼“å­˜
        variant: ${{ inputs.clean_build && 'none' || 'ccache' }}

    - name: Initialization environment
      id: init
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        echo "=== å®‰è£…ç¼–è¯‘ä¾èµ– ==="
        sudo -E apt-get -y update
    
        # å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆç§»é™¤ python3-distutilsï¼‰
        sudo -E apt-get -y install build-essential clang flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
        python3 python3-dev python3-setuptools python3-pip rsync unzip zlib1g-dev file wget \
        python3-pyelftools
    
        # é€šè¿‡ pip å®‰è£… distutils çš„æ›¿ä»£å“
        python3 -m pip install --upgrade pip setuptools wheel
    
        # å®‰è£…ç‰¹å®šä¾èµ–
        sudo -E apt-get -y install $(curl -fsSL https://raw.githubusercontent.com/xuxin1955/depend_ubuntu2204_openwrt/refs/heads/main/depend_ubuntu2204_openwrt) || true
    
        # å®‰è£… mkbootimg
        wget https://raw.githubusercontent.com/xuxin1955/depend_ubuntu2204_openwrt/main/mkbootimg_10.0.0+r36-9_all.deb
        sudo dpkg -i mkbootimg_10.0.0+r36-9_all.deb || true
        sudo apt-get install -f -y
    
        # éªŒè¯å®‰è£…
        mkbootimg --help || true
    
        # åˆ›å»º distutils å…¼å®¹æ€§é“¾æ¥ï¼ˆå¦‚æœè¿˜éœ€è¦ï¼‰
        python3 -c "import setuptools; import sys; print('setuptools version:', setuptools.__version__)" || {
          echo "é‡æ–°å®‰è£… setuptools..."
          python3 -m pip install --force-reinstall setuptools
        }
    
        sudo timedatectl set-timezone "${TZ}"
        echo "status=success" >> ${GITHUB_OUTPUT}

    - name: Clone source code
      if: steps.init.outputs.status == 'success'
      run: |
        echo "=== å…‹éš†æºç  ==="
        if [ "${{ inputs.clean_build }}" == "true" ]; then
          git clone "$REPO_URL" -b "$REPO_BRANCH" openwrt
        else
          git clone --depth 1 "$REPO_URL" -b "$REPO_BRANCH" openwrt
        fi

    - name: Setup build directories
      run: |
        echo "=== è®¾ç½®ç¼–è¯‘ç›®å½• ==="
        sudo mkdir -p /mnt/openwrt/{dl,staging_dir,build_dir,ccache}
        sudo chown -R $USER:$GROUPS /mnt/openwrt
        
        # åˆ›å»ºè½¯é“¾æ¥
        ln -sfn /mnt/openwrt/dl openwrt/dl
        ln -sfn /mnt/openwrt/staging_dir openwrt/staging_dir
        ln -sfn /mnt/openwrt/build_dir openwrt/build_dir
        
        # è®¾ç½® ccache ç›®å½•
        export CCACHE_DIR=/mnt/openwrt/ccache
        echo "CCACHE_DIR=/mnt/openwrt/ccache" >> $GITHUB_ENV
        
        df -h

    - name: Load custom feeds
      run: |
        echo "=== åŠ è½½è‡ªå®šä¹‰ feeds ==="
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
        chmod +x $DIY_P4_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P4_SH

    - name: Update & Install feeds
      working-directory: ./openwrt
      run: |
        echo "=== æ›´æ–° feeds ==="
        ./scripts/feeds update -a
        echo "=== å®‰è£… feeds ==="
        ./scripts/feeds install -a -f

    - name: Configuration Customization
      run: |
        echo "=== é…ç½®å®šåˆ¶ ==="
        cp -fv "${CONFIG_FILE}" openwrt/.config
        
        # å¦‚æœé€‰æ‹©æœ€å°åŒ–ç¼–è¯‘ï¼Œæ³¨é‡Šæ‰å¤§å‹åŒ…
        if [ "${{ inputs.minimal_build }}" == "true" ]; then
          echo ">>> æœ€å°åŒ–ç¼–è¯‘æ¨¡å¼ï¼šæ³¨é‡Šå¤§å‹è½¯ä»¶åŒ…"
          sed -i 's/^CONFIG_PACKAGE_luci-app-qbittorrent=y/# CONFIG_PACKAGE_luci-app-qbittorrent is not set/' openwrt/.config
          sed -i 's/^CONFIG_PACKAGE_qbittorrent=y/# CONFIG_PACKAGE_qbittorrent is not set/' openwrt/.config
          sed -i 's/^CONFIG_PACKAGE_qt6-core=y/# CONFIG_PACKAGE_qt6-core is not set/' openwrt/.config
          sed -i 's/^CONFIG_PACKAGE_boost-system=y/# CONFIG_PACKAGE_boost-system is not set/' openwrt/.config
          sed -i 's/^CONFIG_PACKAGE_samba4-server=y/# CONFIG_PACKAGE_samba4-server is not set/' openwrt/.config
        fi
        
        cd openwrt && make defconfig
        
    - name: SSH connection to Actions
      uses: csexton/debugger-action@master
      if: ${{ inputs.ssh }}
      
    - name: Upload build config
      uses: actions/upload-artifact@v4
      with:
        name: build-config
        path: |
          openwrt/.config
          openwrt/feeds.conf.default
      
    - name: Download packages
      working-directory: ./openwrt
      run: |
        echo "=== ä¸‹è½½è½¯ä»¶åŒ… ==="
        # å…ˆå°è¯•æ­£å¸¸ä¸‹è½½
        make download -j4 V=s || {
          echo ">>> ä¸‹è½½å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹é‡è¯•"
          make download -j1 V=s
        }
        # åˆ é™¤å°äº1KBçš„é”™è¯¯æ–‡ä»¶
        find dl -size -1024c -delete
        
        # æ˜¾ç¤ºä¸‹è½½ç»Ÿè®¡
        echo "ä¸‹è½½å®Œæˆï¼š$(ls dl | wc -l) ä¸ªæ–‡ä»¶"

    - name: Compile with monitoring
      id: compile
      run: |
        cd openwrt/
        
        # å¯åŠ¨åå°ç›‘æ§
        (
          while true; do
            echo "=== ç³»ç»ŸçŠ¶æ€ç›‘æ§ $(date) ==="
            echo "CPU ä½¿ç”¨:"
            top -bn1 | head -20
            echo "å†…å­˜ä½¿ç”¨:"
            free -h
            echo "ç£ç›˜ä½¿ç”¨:"
            df -h /
            echo "ccache ç»Ÿè®¡:"
            ccache -s
            echo "ç­‰å¾…5åˆ†é’Ÿ..."
            sleep 300
          done
        ) > monitor.log 2>&1 &
        MONITOR_PID=$!
        
        echo "=== å¼€å§‹ç¼–è¯‘ ==="
        make defconfig
        
        # æ ¹æ®å‚æ•°é€‰æ‹©ç¼–è¯‘æ¨¡å¼
        if [[ "${{ inputs.log_switch }}" == "true" ]]; then
            # è¯¦ç»†æ—¥å¿—æ¨¡å¼ï¼Œä½†ä½¿ç”¨2ä¸ªçº¿ç¨‹å¹³è¡¡é€Ÿåº¦ä¸ç¨³å®šæ€§
            make -j2 V=s 2>&1 | tee build.log
        elif [[ "${{ inputs.minimal_build }}" == "true" ]]; then
            # æœ€å°åŒ–ç¼–è¯‘ï¼Œä½¿ç”¨å…¨éƒ¨æ ¸å¿ƒ
            make -j$(nproc)
        else
            # æ­£å¸¸ç¼–è¯‘ï¼Œä½¿ç”¨æ ¸å¿ƒæ•°çš„ä¸€åŠï¼Œé¿å…å†…å­˜è€—å°½
            make -j$(( $(nproc) / 2 + 1 ))
        fi
        
        # åœæ­¢ç›‘æ§
        kill $MONITOR_PID 2>/dev/null || true
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        if [ -f bin/targets/*/*/*-squashfs-* ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸ"
          grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
          [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          # ä¸Šä¼ ç¼–è¯‘æ—¥å¿—ç”¨äºè°ƒè¯•
          cp build.log /tmp/ || true
          exit 1
        fi

    - name: Upload build logs on failure
      if: failure() && steps.compile.outcome == 'failure'
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          openwrt/build.log
          openwrt/monitor.log
          openwrt/logs/
          openwrt/dl/
        retention-days: 7
        
    - name: Organize firmware files
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && steps.compile.outputs.status == 'success'
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT
        
        echo "å›ºä»¶æ–‡ä»¶åˆ—è¡¨ï¼š"
        ls -lh

    - name: Upload firmware to artifacts
      uses: actions/upload-artifact@v4
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware_XG-040G-MD${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}${{ inputs.minimal_build && '_minimal' || '' }}
        path: ${{ env.FIRMWARE }}/*

    - name: Generate release info
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && steps.organize.outputs.status == 'success'
      run: |
        echo "release_tag=HomeProxy-$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        
        cat <<EOF > release.txt
        ğŸš€ OpenWrt å›ºä»¶ for XG-040G-MD
        
        ### ç¼–è¯‘ä¿¡æ¯
        - **æ—¶é—´**: $(date +"%Y-%m-%d %H:%M:%S")
        - **æºç **: $REPO_URL
        - **åˆ†æ”¯**: $REPO_BRANCH
        - **æ¨¡å¼**: ${{ inputs.minimal_build && 'æœ€å°åŒ–ç¼–è¯‘' || 'å®Œæ•´ç¼–è¯‘' }}
        
        ### åŒ…å«çš„ä¸»è¦åŠŸèƒ½
        - âœ… HomeProxy (ä»£ç†)
        - âœ… mwan3 (å¤šçº¿è´Ÿè½½å‡è¡¡)
        - âœ… SmartDNS
        - âœ… ZeroTier (VPN)
        ${{ !inputs.minimal_build && '  - âœ… qBittorrent (ä¸‹è½½)' || '  - â¸ï¸ qBittorrent (æœ€å°åŒ–æ¨¡å¼å·²ç¦ç”¨)' }}
        - âœ… vsFTPd (FTPæœåŠ¡å™¨)
        ${{ !inputs.minimal_build && '  - âœ… Samba4 (æ–‡ä»¶å…±äº«)' || '  - â¸ï¸ Samba4 (æœ€å°åŒ–æ¨¡å¼å·²ç¦ç”¨)' }}
        - âœ… diskman (ç£ç›˜ç®¡ç†)
        - âœ… CPUçŠ¶æ€ç›‘æ§
        - âœ… ttyd (Webç»ˆç«¯)
        
        ### å®‰è£…è¯´æ˜
        1. ä¸‹è½½å¯¹åº”è®¾å¤‡çš„å›ºä»¶æ–‡ä»¶
        2. åœ¨è·¯ç”±å™¨åå°å‡çº§æˆ–é€šè¿‡ breed åˆ·å…¥
        3. é»˜è®¤IP: 192.168.2.1
        4. é»˜è®¤å¯†ç : password
        
        ### æ³¨æ„äº‹é¡¹
        - é¦–æ¬¡åˆ·æœºåå»ºè®®æ¢å¤å‡ºå‚è®¾ç½®
        - å¦‚æœ‰é—®é¢˜è¯·æä¾›ç¼–è¯‘æ—¥å¿—
        EOF
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload firmware to release
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: Cleanup old workflow runs
      uses: LeeHe-gif/delete-workflow-runs@main
      with:
        retain_days: 7
        keep_minimum_runs: 5
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Final status
      if: always()
      run: |
        echo "=== ç¼–è¯‘ç»“æŸ ==="
        echo "çŠ¶æ€: ${{ job.status }}"
        echo "ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
        df -h
        echo "ccache ç»Ÿè®¡:"
        ccache -s
