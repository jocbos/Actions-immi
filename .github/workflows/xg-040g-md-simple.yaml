name: Build Gateway Firmware for XG-040G-MD (ç²¾ç®€ç‰ˆ)

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'ðŸ”§ SSHè°ƒè¯•æ¨¡å¼'
        required: false
        default: false
        type: boolean
      log_switch:
        description: 'ðŸ“ è¯¦ç»†ç¼–è¯‘æ—¥å¿—'
        required: false
        default: false
        type: boolean

env:
  CONFIG_FILE: 'config/gateway.config'
  REPO_URL: https://github.com/bingoguo93/immortalwrt
  REPO_BRANCH: openwrt-25.12
  FEEDS_CONF: feeds.conf.default
  DIY_P4_SH: diy-gateway.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  CCACHE_DIR: /mnt/openwrt/ccache

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 240  # 4å°æ—¶è¶³å¤Ÿ

    steps:
    - name: Checkout
      uses: actions/checkout@master

    - name: Free disk space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: openwrt-gateway-${{ env.REPO_BRANCH }}
        max-size: 3G

    - name: Initialization environment
      id: init
      run: |
        sudo -E apt-get -y update
        sudo -E apt-get -y install build-essential clang flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
        python3 python3-dev python3-setuptools python3-pip rsync unzip zlib1g-dev file wget
        
        sudo timedatectl set-timezone "${TZ}"
        echo "status=success" >> ${GITHUB_OUTPUT}

    - name: Clone source code
      if: steps.init.outputs.status == 'success'
      run: git clone --depth 1 "$REPO_URL" -b "$REPO_BRANCH" openwrt

    - name: Setup build directories
      run: |
        sudo mkdir -p /mnt/openwrt/{dl,staging_dir,build_dir,ccache}
        sudo chown -R $USER:$GROUPS /mnt/openwrt
        ln -sfn /mnt/openwrt/dl openwrt/dl
        ln -sfn /mnt/openwrt/staging_dir openwrt/staging_dir
        ln -sfn /mnt/openwrt/build_dir openwrt/build_dir

    - name: Load custom feeds & diy script
      run: |
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
        chmod +x $DIY_P4_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P4_SH

    - name: Update & Install feeds
      working-directory: ./openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Configuration
      run: |
        cp -fv "${CONFIG_FILE}" openwrt/.config
        cd openwrt && make defconfig

    - name: SSH debug
      uses: csexton/debugger-action@master
      if: ${{ inputs.ssh }}

    - name: Download packages
      working-directory: ./openwrt
      run: make download -j4 V=s

    - name: Compile firmware
      id: compile
      run: |
        cd openwrt/
        make defconfig
        if [[ "${{ inputs.log_switch }}" == "true" ]]; then
            make -j1 V=s
        else
            make -j$(nproc)
        fi
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Organize files
      if: env.UPLOAD_FIRMWARE == 'true' && steps.compile.outputs.status == 'success'
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      if: steps.compile.outputs.status == 'success'
      with:
        name: OpenWrt_gateway_XG-040G-MD${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}/*

    - name: Generate release info
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && steps.compile.outputs.status == 'success'
      run: |
        echo "release_tag=Gateway-$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        cat <<EOF > release.txt
        ðŸš€ OpenWrt ç½‘å…³å›ºä»¶ for XG-040G-MD (ç²¾ç®€ç‰ˆ)
        ----------------------
        è®¾å¤‡: XG-040G-MD
        æ—¶é—´: $(date +"%Y-%m-%d %H:%M")
        
        ### åŒ…å«åŠŸèƒ½
        - mwan3 (å¤šçº¿è´Ÿè½½å‡è¡¡)
        - SmartDNS (DNSåŠ é€Ÿ)
        - ZeroTier (VPNç»„ç½‘)
        - HomeProxy (ä»£ç†)
        - SQM QoS (æµé‡æ•´å½¢)
        - Watchcat (çœ‹é—¨ç‹—)
        - ttyd (Webç»ˆç«¯)
        
        ### ç²¾ç®€è¯´æ˜Ž
        âœ… åªä¿ç•™ç½‘ç»œæ ¸å¿ƒåŠŸèƒ½
        âœ… æ— ä¸‹è½½ã€æ— å…±äº«ã€æ— å¤–æŽ¥å­˜å‚¨ä¾èµ–
        âœ… 256MB å­˜å‚¨ç»°ç»°æœ‰ä½™
        EOF
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload to release
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.status == 'success'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*
