name: Build Gateway Firmware for XG-040G-MD spring

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'ðŸ”§ SSHè°ƒè¯•æ¨¡å¼'
        required: false
        default: false
        type: boolean
      log_switch:
        description: 'ðŸ“ è¯¦ç»†ç¼–è¯‘æ—¥å¿—'
        required: false
        default: false
        type: boolean
  schedule:
    - cron: '0 20 * * 0'  # æ¯å‘¨æ—¥æ™š8ç‚¹è‡ªåŠ¨ç¼–è¯‘
  push:
    branches: [main, master]
    paths:
      - 'config/**'
      - 'diy-gateway.sh'

env:
  CONFIG_FILE: 'config/gateway1.config'
  REPO_URL: https://github.com/bingoguo93/immortalwrt
  REPO_BRANCH: openwrt-25.12
  FEEDS_CONF: feeds.conf.default
  DIY_P4_SH: diy-gateway1.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
    - name: Checkout
      uses: actions/checkout@master
      with:
        fetch-depth: 0

    - name: Free disk space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        large-packages: true
        docker-images: true

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ github.workflow }}-${{ github.job }}
        max-size: 2G
        save: true

    - name: Initialization environment
      id: init
      run: |
        sudo -E apt-get -y update
        sudo -E apt-get -y install build-essential clang flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
        python3 python3-dev python3-setuptools python3-pip rsync unzip zlib1g-dev file wget \
        pigz libelf-dev ecj fastjar
        
        sudo timedatectl set-timezone "${TZ}"
        sudo ln -sf /usr/bin/python3 /usr/bin/python
        echo "status=success" >> ${GITHUB_OUTPUT}

    - name: Clone source code
      if: steps.init.outputs.status == 'success'
      run: |
        for i in {1..3}; do
          git clone --depth 1 "$REPO_URL" -b "$REPO_BRANCH" openwrt && break || sleep 10
        done

    - name: Setup build directories
      run: |
        sudo mkdir -p /mnt/openwrt/{dl,staging_dir,build_dir,ccache}
        sudo chown -R $USER:$GROUPS /mnt/openwrt
        ln -sfn /mnt/openwrt/dl openwrt/dl
        ln -sfn /mnt/openwrt/staging_dir openwrt/staging_dir
        ln -sfn /mnt/openwrt/build_dir openwrt/build_dir

    - name: Load custom feeds & diy script
      run: |
        [ -e $FEEDS_CONF ] && cp $FEEDS_CONF openwrt/feeds.conf.default
        chmod +x $DIY_P4_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P4_SH

    - name: Update & Install feeds
      working-directory: ./openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Configuration
      run: |
        cp -fv "${CONFIG_FILE}" openwrt/.config
        cd openwrt
        make defconfig

    - name: SSH debug
      uses: csexton/debugger-action@master
      if: ${{ inputs.ssh }}

    - name: Download packages
      working-directory: ./openwrt
      run: |
        make download -j8 V=s || make download -j1 V=s
        find dl -size -1024c -exec ls -l {} \;

    - name: Compile firmware
      id: compile
      run: |
        cd openwrt/
        START_TIME=$(date +%s)
        
        if [[ "${{ inputs.log_switch }}" == "true" ]]; then
            make -j1 V=s
        else
            CORES=$(nproc)
            BUILD_CORES=$(( CORES * 80 / 100 ))
            [ $BUILD_CORES -lt 1 ] && BUILD_CORES=1
            echo "ä½¿ç”¨ $BUILD_CORES ä¸ªæ ¸å¿ƒç¼–è¯‘"
            make -j${BUILD_CORES}
        fi
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "ç¼–è¯‘è€—æ—¶: $((DURATION/60))åˆ†$((DURATION%60))ç§’"
        
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Organize files
      if: env.UPLOAD_FIRMWARE == 'true' && steps.compile.outputs.status == 'success'
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        
        cat > firmware_info.txt << EOF
        ç¼–è¯‘æ—¶é—´: $(date +"%Y-%m-%d %H:%M:%S")
        ç›®æ ‡è®¾å¤‡: XG-040G-MD
        åŠŸèƒ½: è€ç‰ˆfirewall + ksmbd/vsftpd + Aria2 + sirboyä¸»é¢˜
        EOF

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      if: steps.compile.outputs.status == 'success'
      with:
        name: OpenWrt_XG-040G-MD${{ env.FILE_DATE }}
        path: |
          ${{ env.FIRMWARE }}/*
          !${{ env.FIRMWARE }}/packages

    - name: Generate release info
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && steps.compile.outputs.status == 'success'
      run: |
        echo "release_tag=XG-040G-MD-$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        
        cat <<EOF > release.txt
        ðŸš€ XG-040G-MD ç½‘å…³å›ºä»¶ (å…¨èƒ½ç‰ˆ)
        ----------------------
        ðŸ“… ç¼–è¯‘æ—¶é—´: $(date +"%Y-%m-%d %H:%M")
        
        ### âœ¨ åŠŸèƒ½ç‰¹æ€§
        - **é˜²ç«å¢™**: è€ç‰ˆ iptables (å®Œç¾Žå…¼å®¹mwan3)
        - **æ–‡ä»¶å…±äº«**: ksmbd (SMB) + vsftpd (FTP)
        - **ä¸‹è½½æœåŠ¡**: Aria2 + AriaNg (HTTP/BT/ç£åŠ›é“¾)
        - **ç¾ŽåŒ–ä¸»é¢˜**: sirboy kucatä¸»é¢˜ + advancedplus
        - **ç½‘ç»œæ ¸å¿ƒ**: mwan3 + SmartDNS + HomeProxy + ZeroTier
        - **IPTV**: igmpproxy + udpxy
        - **ç½‘ç»œåŠ é€Ÿ**: Shortcut-FE + BBR
        
        ### ðŸ”§ ç²¾ç®€è¯´æ˜Ž
        - âœ… ç§»é™¤SQM (å®žé™…ä¸èµ·ä½œç”¨)
        - âœ… è€ç‰ˆfirewallé¿å…ä¸Žmwan3å†²çª
        - âœ… USBè‡ªåŠ¨æŒ‚è½½ (/mnt/usb_disk)
        
        ### ðŸ“ è®¿é—®æ–¹å¼
        - **è·¯ç”±å™¨**: http://192.168.100.254
        - **AriaNgä¸‹è½½ç®¡ç†**: http://192.168.100.254/ariang
        - **FTP**: ftp://192.168.100.254
        - **SMBå…±äº«**: \\\\192.168.100.254\\USB_Share
        
        ### ðŸ“¥ åˆ·æœºè¯´æ˜Ž
        1. ä¸‹è½½ sysupgrade å›ºä»¶
        2. åœ¨çŽ°æœ‰ OpenWrt ä¸­åˆ·å…¥
        3. é¦–æ¬¡åˆ·å…¥å»ºè®®æ¢å¤å‡ºåŽ‚è®¾ç½®
        EOF
        
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload to release
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.status == 'success'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*.bin
