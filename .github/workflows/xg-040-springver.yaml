yaml
name: Build XG-040G-MD è€æ¥¼ç‰ˆ

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'ðŸ”§ SSHè°ƒè¯•æ¨¡å¼'
        required: false
        default: false
        type: boolean
  

env:
  CONFIG_FILE: 'config/gateway1.config'
  DIY_SCRIPT: diy-gateway1.sh
  REPO_URL: https://github.com/bingoguo93/immortalwrt
  REPO_BRANCH: openwrt-25.12
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 300

    steps:
    - uses: actions/checkout@master

    - name: æ¸…ç†ç£ç›˜ç©ºé—´
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        large-packages: true

    - name: å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
        python3 python3-setuptools rsync unzip zlib1g-dev file wget pigz

    - name: å…‹éš†æºç 
      run: git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt

    - name: åˆ›å»ºç¼“å­˜ç›®å½•
      run: |
        sudo mkdir -p /mnt/openwrt/{dl,ccache}
        sudo chown -R $USER:$GROUPS /mnt/openwrt
        ln -sfn /mnt/openwrt/dl openwrt/dl

    - name: è¿è¡ŒDIYè„šæœ¬
      run: |
        chmod +x $DIY_SCRIPT
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_SCRIPT

    - name: æ›´æ–°feeds
      working-directory: ./openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: åº”ç”¨é…ç½®
      run: |
        cp -f "${CONFIG_FILE}" openwrt/.config
        cd openwrt && make defconfig

    - name: ä¸‹è½½æºç åŒ…
      working-directory: ./openwrt
      run: make download -j8 || make download -j1

    - name: ç¼–è¯‘å›ºä»¶
      working-directory: ./openwrt
      run: |
        START_TIME=$(date +%s)
        make -j$(nproc)
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: æ•´ç†å›ºä»¶
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV

    - name: ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@v4
      with:
        name: XG-040G-MD_å…¨èƒ½ç‰ˆ${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}/*.bin
