name: Build Gateway Firmware for XG-040G-MD

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'ðŸ”§ SSHè°ƒè¯•æ¨¡å¼'
        required: false
        default: false
        type: boolean
      log_switch:
        description: 'ðŸ“ è¯¦ç»†ç¼–è¯‘æ—¥å¿—'
        required: false
        default: false
        type: boolean
  schedule:
    - cron: '0 20 * * 0'
  push:
    branches: [main, master]
    paths:
      - 'config/**'
      - 'diy-gateway1.sh'

env:
  CONFIG_FILE: 'config/gateway1.config'
  DIY_P4_SH: diy-gateway1.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
    - name: Checkout
      uses: actions/checkout@master
      with:
        fetch-depth: 0

    - name: Free disk space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        large-packages: true
        docker-images: true

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ github.workflow }}-${{ github.job }}
        max-size: 2G
        save: true

    - name: Initialization environment
      id: init
      run: |
        sudo -E apt-get -y update
        sudo -E apt-get -y install build-essential clang flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
        python3 python3-dev python3-setuptools python3-pip rsync unzip zlib1g-dev file wget \
        pigz libelf-dev ecj fastjar
        
        sudo timedatectl set-timezone "${TZ}"
        sudo ln -sf /usr/bin/python3 /usr/bin/python
        echo "status=success" >> ${GITHUB_OUTPUT}

    - name: Clone source code
      if: steps.init.outputs.status == 'success'
      run: |
        git clone --depth 1 https://github.com/bingoguo93/immortalwrt -b openwrt-25.12 openwrt

    - name: Setup build directories
      run: |
        sudo mkdir -p /mnt/openwrt/{dl,staging_dir,build_dir,ccache}
        sudo chown -R $USER:$GROUPS /mnt/openwrt
        ln -sfn /mnt/openwrt/dl openwrt/dl
        ln -sfn /mnt/openwrt/staging_dir openwrt/staging_dir
        ln -sfn /mnt/openwrt/build_dir openwrt/build_dir

    - name: Run DIY script
      run: |
        chmod +x $DIY_P4_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P4_SH

    - name: Update & Install feeds
      working-directory: ./openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Run post-feeds script
      working-directory: ./openwrt
      run: |
        if [ -f "$GITHUB_WORKSPACE/post-feeds.sh" ]; then
          $GITHUB_WORKSPACE/post-feeds.sh
        fi

    - name: Configuration
      run: |
        cp -fv "${CONFIG_FILE}" openwrt/.config
        cd openwrt
        make defconfig

    - name: SSH debug
      uses: csexton/debugger-action@master
      if: ${{ inputs.ssh }}

    - name: Download packages
      working-directory: ./openwrt
      run: |
        make download -j8 V=s || make download -j1 V=s

    - name: Compile firmware
      id: compile
      run: |
        cd openwrt/
        START_TIME=$(date +%s)
        
        if [[ "${{ inputs.log_switch }}" == "true" ]]; then
            make -j1 V=s
        else
            CORES=$(nproc)
            BUILD_CORES=$(( CORES * 80 / 100 ))
            [ $BUILD_CORES -lt 1 ] && BUILD_CORES=1
            echo "ä½¿ç”¨ $BUILD_CORES ä¸ªæ ¸å¿ƒç¼–è¯‘"
            make -j${BUILD_CORES}
        fi
        
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Organize files
      if: env.UPLOAD_FIRMWARE == 'true' && steps.compile.outputs.status == 'success'
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      if: steps.compile.outputs.status == 'success'
      with:
        name: OpenWrt_XG-040G-MD${{ env.FILE_DATE }}
        path: |
          ${{ env.FIRMWARE }}/*.bin
          ${{ env.FIRMWARE }}/*.manifest

    - name: Generate release info
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && steps.compile.outputs.status == 'success'
      run: |
        echo "release_tag=XG-040G-MD-$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        
        cat <<EOF > release.txt
        ðŸš€ XG-040G-MD ç½‘å…³å›ºä»¶
        ----------------------
        ðŸ“… ç¼–è¯‘æ—¶é—´: $(date +"%Y-%m-%d %H:%M")
        
        ### âœ¨ åŠŸèƒ½ç‰¹æ€§
        - **é˜²ç«å¢™**: è€ç‰ˆ iptables
        - **æ–‡ä»¶å…±äº«**: ksmbd (SMB) + vsftpd (FTP)
        - **ä¸‹è½½æœåŠ¡**: Aria2 + AriaNg
        - **ç¾ŽåŒ–ä¸»é¢˜**: kucat + advancedplus
        - **ç½‘ç»œæ ¸å¿ƒ**: mwan3 + SmartDNS + HomeProxy + ZeroTier
        - **IPTV**: igmpproxy + udpxy
        - **ç½‘ç»œåŠ é€Ÿ**: Shortcut-FE + BBR
        
        ### ðŸ“ è®¿é—®æ–¹å¼
        - **è·¯ç”±å™¨**: http://192.168.100.254
        - **ä¸‹è½½ç®¡ç†**: http://192.168.100.254/ariang
        - **FTP**: ftp://192.168.100.254
        - **SMB**: \\\\192.168.100.254\\USB_Share
        EOF
        
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload to release
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.status == 'success'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*.bin
