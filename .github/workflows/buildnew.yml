name: Build XG-040G-MD é˜¿æ¥¼ç‰ˆ

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'ğŸ”§ SSHè°ƒè¯•æ¨¡å¼'
        required: false
        default: false
        type: boolean
      log_switch:
        description: 'ğŸ“ è¯¦ç»†ç¼–è¯‘æ—¥å¿—'
        required: false
        default: false
        type: boolean
  push:
    branches: [main, master]
    paths:
      - 'config/**'
      - 'diy-gateway1.sh'
      - 'post-feeds.sh'

env:
  CONFIG_FILE: 'config/new.config'
  DIY_SCRIPT: new.sh
  REPO_URL: https://github.com/bingoguo93/immortalwrt
  REPO_BRANCH: openwrt-25.12
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 300

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@master

    - name: æ¸…ç†ç£ç›˜ç©ºé—´
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        large-packages: true

    - name: å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
        python3 python3-setuptools rsync unzip zlib1g-dev file wget pigz ccache

    - name: å…‹éš†æºç 
      run: git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt

    - name: åˆ›å»ºç¼“å­˜ç›®å½•
      run: |
        sudo mkdir -p /mnt/openwrt/{dl,ccache}
        sudo chown -R $USER:$GROUPS /mnt/openwrt
        ln -sfn /mnt/openwrt/dl openwrt/dl
        
    - name: é…ç½®ccache
      run: |
        mkdir -p ~/.ccache
        ccache -M 5G
        echo 'export PATH="/usr/lib/ccache:$PATH"' >> ~/.bashrc

    - name: æ¢å¤dlç¼“å­˜
      uses: actions/cache@v4
      with:
        path: /mnt/openwrt/dl
        key: ${{ runner.os }}-immortalwrt-dl-${{ hashFiles('feeds.conf.default') }}
        restore-keys: |
          ${{ runner.os }}-immortalwrt-dl-

    - name: è¿è¡ŒDIYè„šæœ¬
      run: |
        chmod +x $DIY_SCRIPT
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_SCRIPT

    - name: æ›´æ–°feeds
      working-directory: ./openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: è¿è¡Œpost-feedsè„šæœ¬
      working-directory: ./openwrt
      run: |
        chmod +x $GITHUB_WORKSPACE/post-feeds.sh
        $GITHUB_WORKSPACE/post-feeds.sh

    - name: åº”ç”¨é…ç½®
      run: |
        cp -f "${CONFIG_FILE}" openwrt/.config
        cd openwrt && make defconfig

    - name: ä¸‹è½½æºç åŒ…
      working-directory: ./openwrt
      run: make download -j8 || make download -j1 V=s

    - name: ç¼–è¯‘å›ºä»¶
      working-directory: ./openwrt
      run: |
        START_TIME=$(date +%s)
        if [[ "${{ github.event.inputs.log_switch }}" == "true" ]]; then
            echo "ğŸ” ä½¿ç”¨è¯¦ç»†æ—¥å¿—æ¨¡å¼ç¼–è¯‘"
            make -j1 V=s
        else
            echo "ğŸš€ ä½¿ç”¨å¹¶è¡Œæ¨¡å¼ç¼–è¯‘"
            make -j$(nproc)
        fi
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: è¯†åˆ«è®¾å¤‡åç§°
      working-directory: ./openwrt
      run: |
        DEVICE=$(grep 'CONFIG_TARGET.*DEVICE.*=y' .config | head -1 | sed 's/.*DEVICE_\(.*\)=y/\1/')
        echo "DEVICE_NAME=$DEVICE" >> $GITHUB_ENV

    - name: æ•´ç†å›ºä»¶
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "å›ºä»¶ç”Ÿæˆåœ¨: $PWD"
        ls -la

    - name: ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@v4
      with:
        name: XG-040G-MD_å°æ¥¼ç‰ˆ${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}/*.bin