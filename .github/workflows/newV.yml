name: Build XG-040G-MD webdav ç‰ˆ

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'ğŸ”§ SSHè°ƒè¯•æ¨¡å¼'
        required: false
        default: false
        type: boolean
      log_switch:
        description: 'ğŸ“ è¯¦ç»†ç¼–è¯‘æ—¥å¿—'
        required: false
        default: false
        type: boolean
 

env:
  CONFIG_FILE: 'config/alistV.config'
  DIY_SCRIPT: new.sh
  REPO_URL: https://github.com/bingoguo93/immortalwrt
  REPO_BRANCH: openwrt-25.12
  TZ: Asia/Shanghai
  UPLOAD_RELEASE: true
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 300
    permissions:
      contents: write
      actions: write

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: æ¸…ç†ç£ç›˜ç©ºé—´
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        large-packages: true

    - name: å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
        python3 python3-setuptools rsync unzip zlib1g-dev file wget pigz ccache  

    - name: å…‹éš†æºç 
      run: git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt

    - name: åˆ›å»ºç¼“å­˜ç›®å½•
      run: |
        sudo mkdir -p /mnt/openwrt/{dl,ccache}
        sudo chown -R $USER:$GROUPS /mnt/openwrt
        ln -sfn /mnt/openwrt/dl openwrt/dl
        
    - name: é…ç½®ccache
      run: |
        mkdir -p ~/.ccache
        ccache -M 5G
        echo 'export PATH="/usr/lib/ccache:$PATH"' >> ~/.bashrc

    - name: æ¢å¤dlç¼“å­˜
      uses: actions/cache@v4
      with:
        path: /mnt/openwrt/dl
        key: ${{ runner.os }}-immortalwrt-dl-${{ hashFiles('feeds.conf.default') }}
        restore-keys: |
          ${{ runner.os }}-immortalwrt-dl-

    - name: è¿è¡ŒDIYè„šæœ¬
      run: |
        chmod +x $DIY_SCRIPT
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_SCRIPT

    - name: Update & Install feeds
      working-directory: ./openwrt
      run: |
        echo "å½“å‰ feeds.conf.default å†…å®¹ï¼š"
        cat feeds.conf.default
    
         echo "æµ‹è¯•ç½‘ç»œè¿æ¥..."
        ping -c 3 github.com || true
        ping -c 3 git.immortalwrt.org || true
    
        echo "å¼€å§‹æ›´æ–° feedsï¼ˆå¸¦è¯¦ç»†è¾“å‡ºï¼‰..."
        ./scripts/feeds update -a -v
    
        # æ£€æŸ¥æ˜¯å¦ä¸‹è½½æˆåŠŸ
        echo "æ£€æŸ¥ä¸‹è½½çš„ feedsï¼š"
        ls -la feeds/ || true
    
        if [ ! -d "feeds/packages" ]; then
           echo "ç¬¬ä¸€æ¬¡æ›´æ–°å¤±è´¥ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
        sleep 10
        ./scripts/feeds update -a -v
        fi
    
        # å®‰è£… feeds
        ./scripts/feeds install -a

    - name: è¿è¡Œpost-feedsè„šæœ¬
      working-directory: ./openwrt
      run: |
        chmod +x $GITHUB_WORKSPACE/post-feeds.sh
        $GITHUB_WORKSPACE/post-feeds.sh

    - name: åº”ç”¨é…ç½®
      run: |
        cp -f "${CONFIG_FILE}" openwrt/.config
        cd openwrt && make defconfig

    - name: ä¸‹è½½æºç åŒ…
      working-directory: ./openwrt
      run: make download -j8 || make download -j1 V=s

    - name: ç¼–è¯‘å›ºä»¶
      working-directory: ./openwrt
      run: |
        START_TIME=$(date +%s)
        if [[ "${{ github.event.inputs.log_switch }}" == "true" ]]; then
            echo "ğŸ” ä½¿ç”¨è¯¦ç»†æ—¥å¿—æ¨¡å¼ç¼–è¯‘"
            make -j1 V=s
        else
            echo "ğŸš€ ä½¿ç”¨å¹¶è¡Œæ¨¡å¼ç¼–è¯‘"
            make -j$(nproc)
        fi
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: è¯†åˆ«è®¾å¤‡åç§°
      working-directory: ./openwrt
      run: |
        DEVICE=$(grep 'CONFIG_TARGET.*DEVICE.*=y' .config | head -1 | sed 's/.*DEVICE_\(.*\)=y/\1/')
        echo "DEVICE_NAME=$DEVICE" >> $GITHUB_ENV
        echo "RELEASE_TAG=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_ENV

    - name: æ•´ç†å›ºä»¶
      id: organize
      run: |
        cd openwrt/bin/targets/*/*
        # rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "âœ… å›ºä»¶ç”Ÿæˆåœ¨: $PWD"
        ls -la
        
        # è·å–å›ºä»¶æ–‡ä»¶å
        FW_FILE=$(ls *.bin | head -1)
        echo "FW_FILE=$FW_FILE" >> $GITHUB_ENV
        echo "FW_PATH=$PWD/$FW_FILE" >> $GITHUB_ENV

    - name: ç”ŸæˆReleaseä¿¡æ¯
      id: release_info
      run: |
        # è·å–ç¼–è¯‘æ—¶é—´
        BUILD_TIME=$(date +"%Y-%m-%d %H:%M:%S")
        
        # åˆ›å»ºReleaseè¯´æ˜
        cat > release.md <<EOF
        ## ğŸš€ XG-040G-MD å°æ¥¼ç‰ˆå›ºä»¶
        
        **ç¼–è¯‘æ—¶é—´**: $BUILD_TIME
        **è®¾å¤‡å‹å·**: XG-040G-MD
        **æºç ä»“åº“**: $REPO_URL
        **åˆ†æ”¯**: $REPO_BRANCH
        
        ### âœ¨ åŠŸèƒ½ç‰¹æ€§
        - é˜²ç«å¢™: è€ç‰ˆ iptables
        - ç½‘ç»œæ ¸å¿ƒ: mwan3 + SmartDNS + ZeroTier + HomeProxy + UPnP
        - æ–‡ä»¶å…±äº«: ksmbd (SMB) + vsftpd (FTP)
        - ä¸‹è½½æœåŠ¡: Transmission (web-control ç¾åŒ–ç‰ˆ)
        - ç½‘ç»œåŠ é€Ÿ: Shortcut-FE + BBR + NPUç¡¬ä»¶åŠ é€Ÿ
        - ç¾åŒ–ä¸»é¢˜: kucat + advancedplus
        
        ### ğŸ“¦ åŒ…å«çš„è½¯ä»¶åŒ…
        \`\`\`
        $(cat openwrt/.config | grep -E '^CONFIG_PACKAGE_.*=y' | sed 's/CONFIG_PACKAGE_//g; s/=y//g' | head -20)
        ...
        \`\`\`
        
        ### ğŸ“¥ ä¸‹è½½
        - å›ºä»¶æ–‡ä»¶: \`${{ env.FW_FILE }}\`
        - æ–‡ä»¶å¤§å°: $(du -h ${{ env.FW_PATH }} | cut -f1)
        
        ### ğŸ”§ åˆ·æœºè¯´æ˜
        1. è¿›å…¥ U-Bootï¼ˆæŒ‡ç¤ºç¯é—ªçƒ5æ¬¡æ—¶è®¿é—® http://192.168.1.1ï¼‰
        2. é€‰æ‹©æœ¬å›ºä»¶æ–‡ä»¶ä¸Šä¼ 
        3. ç­‰å¾…åˆ·å†™å®Œæˆè‡ªåŠ¨é‡å¯
        4. é»˜è®¤IP: 192.168.100.254
        
        ### âš ï¸ æ³¨æ„äº‹é¡¹
        - é¦–æ¬¡å¯åŠ¨è¾ƒæ…¢ï¼Œè¯·è€å¿ƒç­‰å¾…2-3åˆ†é’Ÿ
        - å»ºè®®ä¸ä¿ç•™é…ç½®åˆ·å…¥
        - åˆ·æœºæœ‰é£é™©ï¼Œè¯·å¤‡ä»½åŸå‚å›ºä»¶
        EOF
        
        echo "âœ… Releaseä¿¡æ¯ç”Ÿæˆå®Œæ¯•"

    - name: ä¸Šä¼ å›ºä»¶åˆ°Artifact
      uses: actions/upload-artifact@v4
      with:
        name: XG-040G-MD_å°æ¥¼ç‰ˆ_${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}/*.bin
        retention-days: 90  # Artifactä¿ç•™90å¤©

    - name: åˆ›å»ºGitHub Release
      id: create_release
      if: env.UPLOAD_RELEASE == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: XG-040G-MD_${{ env.RELEASE_TAG }}
        name: XG-040G-MD å°æ¥¼ç‰ˆ ${{ env.RELEASE_TAG }}
        body_path: release.md
        files: |
          ${{ env.FIRMWARE }}/*.bin
          openwrt/.config
        draft: false
        prerelease: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ä¸Šä¼ .configé…ç½®æ–‡ä»¶
      if: env.UPLOAD_RELEASE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: build-config-${{ env.RELEASE_TAG }}
        path: |
          config/newV.config
          openwrt/.config
          openwrt/feeds.conf.default

    - name: æ¸…ç†æ—§Releases
      uses: dev-drprasad/delete-older-releases@v0.2.1
      with:
        keep_latest: 5  # ä¿ç•™æœ€è¿‘5ä¸ªRelease
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
