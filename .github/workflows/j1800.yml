name: Build ImmortalWrt for J1800

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'ğŸ”§ SSHè°ƒè¯•æ¨¡å¼'
        required: false
        default: false
        type: boolean
      log_switch:
        description: 'ğŸ“ è¯¦ç»†ç¼–è¯‘æ—¥å¿—'
        required: false
        default: false
        type: boolean

env:
  CONFIG_FILE: 'config/j1800.config'
  DIY_SCRIPT: j1800-new.sh
  REPO_URL: https://github.com/bingoguo93/immortalwrt
  REPO_BRANCH: openwrt-25.12
  TZ: Asia/Shanghai
  UPLOAD_RELEASE: true
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 300
    permissions:
      contents: write
      actions: write

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: æ¸…ç†ç£ç›˜ç©ºé—´
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        large-packages: true

    - name: å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
        python3 python3-setuptools rsync unzip zlib1g-dev file wget pigz ccache

    - name: å…‹éš†æºç 
      run: git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt

    - name: åˆ›å»ºç¼“å­˜ç›®å½•
      run: |
        sudo mkdir -p /mnt/openwrt/{dl,ccache}
        sudo chown -R $USER:$GROUPS /mnt/openwrt
        ln -sfn /mnt/openwrt/dl openwrt/dl
        
    - name: é…ç½®ccache
      run: |
        mkdir -p ~/.ccache
        ccache -M 5G
        echo 'export PATH="/usr/lib/ccache:$PATH"' >> ~/.bashrc

    - name: æ¢å¤dlç¼“å­˜
      uses: actions/cache@v4
      with:
        path: /mnt/openwrt/dl
        key: ${{ runner.os }}-immortalwrt-dl-${{ hashFiles('feeds.conf.default') }}
        restore-keys: |
          ${{ runner.os }}-immortalwrt-dl-

    - name: è¿è¡ŒDIYè„šæœ¬
      run: |
        chmod +x $DIY_SCRIPT
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_SCRIPT

    - name: Update & Install feeds
      working-directory: ./openwrt
      run: |
        echo "å½“å‰ feeds.conf.default å†…å®¹ï¼š"
        cat feeds.conf.default
    
        echo "æµ‹è¯•ç½‘ç»œè¿æ¥..."
        ping -c 3 github.com || true
        ping -c 3 git.immortalwrt.org || true
    
        echo "å¼€å§‹æ›´æ–° feedsï¼ˆå¸¦è¯¦ç»†è¾“å‡ºï¼‰..."
        ./scripts/feeds update -a -v
    
        # æ£€æŸ¥æ˜¯å¦ä¸‹è½½æˆåŠŸ
        echo "æ£€æŸ¥ä¸‹è½½çš„ feedsï¼š"
        ls -la feeds/ || true
    
        if [ ! -d "feeds/packages" ]; then
          echo "ç¬¬ä¸€æ¬¡æ›´æ–°å¤±è´¥ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
          sleep 10
          ./scripts/feeds update -a -v
        fi
    
        # å®‰è£… feeds
        ./scripts/feeds install -a

    - name: è¿è¡Œj1800-post-feedsè„šæœ¬
      working-directory: ./openwrt
      run: |
        chmod +x $GITHUB_WORKSPACE/j1800-post-feeds.sh
        $GITHUB_WORKSPACE/j1800-post-feeds.sh

    - name: åº”ç”¨é…ç½®
      run: |
        cp -f "${CONFIG_FILE}" openwrt/.config
        cd openwrt && make defconfig

    - name: ä¸‹è½½æºç åŒ…
      working-directory: ./openwrt
      run: make download -j8 || make download -j1 V=s

    - name: ç¼–è¯‘å›ºä»¶
      working-directory: ./openwrt
      run: |
        START_TIME=$(date +%s)
        if [[ "${{ github.event.inputs.log_switch }}" == "true" ]]; then
            echo "ğŸ” ä½¿ç”¨è¯¦ç»†æ—¥å¿—æ¨¡å¼ç¼–è¯‘"
            make -j1 V=s
        else
            echo "ğŸš€ ä½¿ç”¨å¹¶è¡Œæ¨¡å¼ç¼–è¯‘"
            make -j$(nproc)
        fi
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: è®¾ç½®ç‰ˆæœ¬ä¿¡æ¯
      run: |
        echo "DEVICE_NAME=J1800" >> $GITHUB_ENV
        echo "RELEASE_TAG=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_ENV

    - name: æ•´ç†å›ºä»¶
      id: organize
      run: |
        cd openwrt/bin/targets/x86/64
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "âœ… å›ºä»¶ç”Ÿæˆåœ¨: $PWD"
        ls -la
        
        # è·å–å›ºä»¶æ–‡ä»¶å (ä¼˜å…ˆå– combined æ ¼å¼)
        FW_FILE=$(ls *-combined*.img.gz 2>/dev/null | head -1)
        if [ -z "$FW_FILE" ]; then
          FW_FILE=$(ls *.img.gz | head -1)
        fi
        echo "FW_FILE=$FW_FILE" >> $GITHUB_ENV
        echo "FW_PATH=$PWD/$FW_FILE" >> $GITHUB_ENV

    - name: ç”ŸæˆReleaseä¿¡æ¯
      id: release_info
      run: |
        # è·å–ç¼–è¯‘æ—¶é—´
        BUILD_TIME=$(date +"%Y-%m-%d %H:%M:%S")
        
        # åˆ›å»ºReleaseè¯´æ˜
        cat > release.md <<EOF
        ## ğŸš€ J1800 æ ‡å‡†ç‰ˆå›ºä»¶ (x86_64)
        
        **ç¼–è¯‘æ—¶é—´**: $BUILD_TIME
        **è®¾å¤‡å‹å·**: J1800 / å‡è…¾ C92 åŠå…¶ä»– x86_64 è½¯è·¯ç”±
        **æºç ä»“åº“**: $REPO_URL
        **åˆ†æ”¯**: $REPO_BRANCH
        
        ### âœ¨ åŠŸèƒ½ç‰¹æ€§
        - é˜²ç«å¢™: firewall4 + nftables (æ–°ç‰ˆ)
        - ç½‘ç»œæ ¸å¿ƒ: mwan3 + SmartDNS + ZeroTier + HomeProxy + UPnP
        - æ–‡ä»¶å…±äº«: ksmbd (SMB)
        - ä¸‹è½½æœåŠ¡: Transmission (web-control ç¾åŒ–ç‰ˆ)
        - USBæ”¯æŒ: RTL8156B 2.5G ç½‘å¡é©±åŠ¨ + å„ç±» USB ç½‘å¡
        - ç£ç›˜ç®¡ç†: diskman + æ–‡ä»¶ç³»ç»Ÿå·¥å…· (ext4/ntfs/exfat/btrfs)
        - ç¾åŒ–ä¸»é¢˜: argon + advancedplus
        
        ### ğŸ“¦ ä¸»è¦è½¯ä»¶åŒ…
        \`\`\`
        firewall4, mwan3, smartdns, zerotier, homeproxy, upnp,
        ksmbd, transmission, luci-app-diskman, kmod-usb-net-rtl8152,
        r8152-firmware, kmod-usb-net-cdc-ncm, iperf3, htop, etc.
        \`\`\`
        
        ### ğŸ“¥ ä¸‹è½½
        - å›ºä»¶æ–‡ä»¶: \`${{ env.FW_FILE }}\`
        - æ–‡ä»¶å¤§å°: $(du -h ${{ env.FW_PATH }} | cut -f1)
        
        ### ğŸ”§ å®‰è£…è¯´æ˜ (x86_64å¹³å°)
        
        **æ–¹æ³•1: å†™ç›˜å®‰è£… (æ¨è)**
        \`\`\`bash
        # è§£å‹å›ºä»¶
        gunzip ${{ env.FW_FILE }}
        
        # å†™å…¥ç¡¬ç›˜/ç”µå­ç›˜ (å‡è®¾ç›®æ ‡ç›˜ä¸º /dev/sda)
        dd if=*.img of=/dev/sda bs=1M status=progress
        
        # é‡å¯å¹¶ä»ç¡¬ç›˜å¯åŠ¨
        \`\`\`
        
        **æ–¹æ³•2: åˆ¶ä½œå¯åŠ¨Uç›˜**
        \`\`\`bash
        # ä½¿ç”¨ Rufus (Windows) æˆ– dd å‘½ä»¤å†™å…¥Uç›˜
        # ä»Uç›˜å¯åŠ¨åï¼Œå¯å†å†™å…¥ç¡¬ç›˜
        \`\`\`
        
        **æ–¹æ³•3: è™šæ‹Ÿæœºä½¿ç”¨**
        - ä½¿ç”¨ç”Ÿæˆçš„ \`*.vmdk\` æˆ– \`*.qcow2\` æ–‡ä»¶
        
        ### âš ï¸ æ³¨æ„äº‹é¡¹
        - é»˜è®¤IP: 192.168.1.1
        - é»˜è®¤ç”¨æˆ·å: root, æ— å¯†ç 
        - é¦–æ¬¡å¯åŠ¨è¾ƒæ…¢ï¼Œè¯·è€å¿ƒç­‰å¾…
        - RTL8156B USBç½‘å¡å·²å†…ç½®é©±åŠ¨ï¼Œå³æ’å³ç”¨
        - å¦‚éœ€ä½¿ç”¨å…¶ä»–USBç½‘å¡ï¼Œå¤§éƒ¨åˆ†ä¹Ÿå·²åŒ…å«é©±åŠ¨
        EOF
        
        echo "âœ… Releaseä¿¡æ¯ç”Ÿæˆå®Œæ¯•"

    - name: ä¸Šä¼ å›ºä»¶åˆ°Artifact
      uses: actions/upload-artifact@v4
      with:
        name: J1800-x86-64_${{ env.FILE_DATE }}
        path: |
          ${{ env.FIRMWARE }}/*.img.gz
          ${{ env.FIRMWARE }}/*.iso
          ${{ env.FIRMWARE }}/*.vmdk
          ${{ env.FIRMWARE }}/*.qcow2
        retention-days: 90

    - name: åˆ›å»ºGitHub Release
      id: create_release
      if: env.UPLOAD_RELEASE == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: J1800-x86-64_${{ env.RELEASE_TAG }}
        name: J1800 x86_64 å›ºä»¶ ${{ env.RELEASE_TAG }}
        body_path: release.md
        files: |
          ${{ env.FIRMWARE }}/*.img.gz
          ${{ env.FIRMWARE }}/*.iso
          ${{ env.FIRMWARE }}/*.vmdk
          ${{ env.FIRMWARE }}/*.qcow2
          openwrt/.config
        draft: false
        prerelease: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ä¸Šä¼ .configé…ç½®æ–‡ä»¶
      if: env.UPLOAD_RELEASE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: build-config-${{ env.RELEASE_TAG }}
        path: |
          config/j1800.config
          openwrt/.config
          openwrt/feeds.conf.default

    - name: æ¸…ç†æ—§Releases
      uses: dev-drprasad/delete-older-releases@v0.2.1
      with:
        keep_latest: 5
